@{
    ViewBag.Title = "Pantalla Inicial";
}

<nav class="navbar navbar-expand-sm  header">
    <div class="container-fluid">
        <img src="https://wp.uaslp.mx/informe/wp-content/uploads/sites/2/2024/04/UASLP.png" alt="" style="max-width: 15%;">
        <div class="rounded-pill">
            <h4>tomas tapia</h4>
            <button class="btn btn-outline-light"><a href="iniciar-sesion.html">Cerrar sesión </a> </button>

        </div>
    </div>
</nav>
<<<<<<< Updated upstream
=======
<div class="row " style="background-color:#004A98;">
    <div class="col"></div>
    <div class="col">
        <button type="button" class="btn  dropdown-toggle" style="background-color:#004A98;  color: white;width:max-content;" data-bs-toggle="dropdown" id="gestionCorredor" aria-expanded="false">Gestión de corredores</button>
    <ul class="dropdown-menu" aria-labelledby="gestionCorredor">
        <li> <button class="dropdown-item" type="button" data-bs-toggle="modal" onclick="location.href='@Url.Action("Crear_Corredor", "Home")'">Nuevo Corredor</button></li>
        <li> <button class="dropdown-item" type="button" data-bs-toggle="modal" onclick="location.href='@Url.Action("Eliminar_Corredor", "Home")'">Eliminar Corredor</button></li>
        <li> <button class="dropdown-item" type="button" data-bs-toggle="modal" onclick="location.href='@Url.Action("Modificar_Corredor", "Home")'">Modificar Corredor</button></li>
        <li> <button class="dropdown-item" type="button" data-bs-toggle="modal" onclick="location.href='@Url.Action("Importar_Corredores", "Home")'">Importar corredores</button></li>
        <li> <button class="dropdown-item" type="button" data-bs-toggle="modal" onclick="location.href='@Url.Action("Importar_tiempos", "Home")'">Importar tiempos</button></li>
        <li> <button class="dropdown-item" type="button" data-bs-toggle="modal" onclick="location.href='@Url.Action("Exportar_corredor", "Home")'">Exportar Corredor</button></li>
         </ul>
    </div>
    <div class="col">
        <button type="button" class="btn  dropdown-toggle" style="background-color:#004A98 ;color: white;width:max-content;" data-bs-toggle="dropdown" id="gestionCarreras" aria-expanded="false">Gestión de carreras</button>
    <ul class="dropdown-menu" aria-labelledby="gestionCarreras">
        <button class="dropdown-item" onclick="window.location.href='@Url.Action("Crear_Carrera", "Home")'">Nueva Carrera</button>
        <button class="dropdown-item" onclick="window.location.href='@Url.Action("Eliminar_Carrera", "Home")'">Eliminar Carrera</button>
        <button class="dropdown-item" onclick="window.location.href='@Url.Action("Editar_Carrera", "Home")'">Editar Carrera</button>
          </ul>
    </div>
    <div class="col">
        <button type="button" class="btn  dropdown-toggle" style="background-color:#004A98 ;color: white;width:max-content;" data-bs-toggle="dropdown" id="gestionCarreras" aria-expanded="false">Gestión de Reportes</button>
        <ul class="dropdown-menu" aria-labelledby="Gestion de reportes">
            <li> <button class="dropdown-item" type="button" data-bs-toggle="modal" onclick="location.href='@Url.Action("Reporte_corredor", "Home")'">Generar reporte de Corredor</button></li>
            <li> <button class="dropdown-item" type="button" data-bs-toggle="modal" onclick="location.href='@Url.Action("Reporte_carrera", "Home")'">Generar reporte de carrera</button></li>
        </ul>
    </div>
    <div class="col" id="btnExportar"><button class="btn " style="background-color:#004A98;color: white;width:max-content;">Exportar resultados</button></div>
    <div class="col"></div>
</div>


>>>>>>> Stashed changes
<br>
<form id="searchForm" method="post" action="@Url.Action("BuscarCorredores", "Home")">
    <!-- Formulario en una línea con distribución de dos mitades -->
    <div class="d-flex justify-content-between">
        <div class="w-50">
            <div class="form-group w-100">
                <label for="nombreCorredor">Nombre del Corredor:</label>
                <input type="text" id="nombreCorredor" name="nombreCorredor" value="@ViewBag.NombreBuscado">
            </div>
        </div>
        <div class="w-50 d-flex justify-content-end">
            <div class="form-group mx-2">
                <label for="yearDropdown">Año:</label>
                <select id="yearDropdown" name="yearCarrera" class="form-control">
                    <option value="">Selecciona un año</option>
                    @foreach (var year in ViewBag.Anios)
                    {
                        <option value="@year">@year</option>
                    }
                </select>
            </div>
            <div class="form-group mx-2">
                <label for="edicionDropdown">Edición:</label>
                <select id="edicionDropdown" name="ediCarrera" class="form-control" disabled>
                    <option value="">Selecciona una edición</option>
                </select>
            </div>
            <div class="form-group mx-2">
                <label for="categoriaDropdown">Categoría:</label>
                <select id="categoriaDropdown" name="categoria" class="form-control" disabled>
                    <option value="">Selecciona una categoría</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary mx-2">Buscar</button>
        </div>
    </div>
</form>

@if (!string.IsNullOrEmpty(ViewBag.Error))
{
    <div class="alert alert-danger">@ViewBag.Error</div>
}


<div class="row">
    <!-- Tabla de resultados (ocupa la mitad de la pantalla) -->
<<<<<<< Updated upstream
    <div class="col-6 ">
        <div id="resultTable" class="mt-4" style=" margin: auto;">
=======

    <div id="resultTable"  style=" margin: auto;padding: 60px">
>>>>>>> Stashed changes

            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Posición</th>
                        <th>Número</th>
                        <th>Nombre</th>
                        <th>T1</th>
                        <th>T2</th>
                        <th>T3</th>
                        <th>Tiempo Total</th>
                    </tr>
                </thead>
                @if (ViewBag.ResultadosBusqueda != null && ViewBag.ResultadosBusqueda.Count > 0)
                {
                    <tbody>
                        @foreach (var corredor in ViewBag.ResultadosBusqueda)
                        {
                            <tr>
                                <td>@corredor["Posicion"]</td>
                                <td>@corredor["NumCorredor"]</td>
                                <td>@corredor["Nombre"]</td>
                                <td>@corredor["T1"]</td>
                                <td>@corredor["T2"]</td>
                                <td>@corredor["T3"]</td>
                                <td>@corredor["T4"]</td>
                            </tr>
                        }
                    </tbody>
                }
                else if (ViewBag.ResultadosBusqueda != null)
                {
                    <p>No se encontraron resultados para los criterios de búsqueda.</p>
                }
            </table>

        </div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        // Cuando cambia el año seleccionado
        $('#yearDropdown').change(function () {
            var year = $(this).val();
            if (year) {
                // Solicitar ediciones para el año seleccionado
                $.getJSON('/Home/CargarEdiciones', { yearCarrera: year }, function (data) {
                    $('#edicionDropdown').empty().append('<option value="">Selecciona una edición</option>');
                    $.each(data, function (i, item) {
                        $('#edicionDropdown').append($('<option>', {
                            value: item,
                            text: item
                        }));
                    });
                    $('#edicionDropdown').prop('disabled', false);
                    $('#categoriaDropdown').empty().append('<option value="">Selecciona una categoría</option>').prop('disabled', true);
                });
            } else {
                $('#edicionDropdown').empty().append('<option value="">Selecciona una edición</option>').prop('disabled', true);
                $('#categoriaDropdown').empty().append('<option value="">Selecciona una categoría</option>').prop('disabled', true);
            }
        });

        // Cuando cambia la edición seleccionada
        $('#edicionDropdown').change(function () {
            var year = $('#yearDropdown').val();
            var edicion = $(this).val();
            if (edicion) {
                // Solicitar categorías para la edición seleccionada
                $.getJSON('/Home/CargarCategorias', { yearCarrera: year, ediCarrera: edicion }, function (data) {
                    $('#categoriaDropdown').empty().append('<option value="">Selecciona una categoría</option>');
                    $.each(data, function (i, item) {
                        $('#categoriaDropdown').append($('<option>', {
                            value: item,
                            text: item
                        }));
                    });
                    $('#categoriaDropdown').prop('disabled', false);
                });
            } else {
                $('#categoriaDropdown').empty().append('<option value="">Selecciona una categoría</option>').prop('disabled', true);
            }
        });
    </script>
    <div class="col-5 " style="text-align: center;">

        <img style="width: 30%; height:45%;" src="https://cdn-icons-png.flaticon.com/512/1986/1986941.png" alt="">
        <br><br>
        <div class="row">
            <div class="col-2"></div>
            <div class="col-4">
                <div class="dropdown">
                    <button type="button" class="btn btn-outline-light dropdown-toggle" style="background-color:#004A98; width:max-content;" data-bs-toggle="dropdown" id="gestionCorredor" aria-expanded="false">Gestión de corredores</button>
                    <ul class="dropdown-menu" aria-labelledby="gestionCorredor">
                        <li> <button class="dropdown-item" type="button" data-bs-toggle="modal" onclick="location.href='@Url.Action("Crear_Corredor", "Home")'">Nuevo Corredor</button></li>
                        <li> <button class="dropdown-item" type="button" data-bs-toggle="modal" onclick="location.href='@Url.Action("Eliminar_Corredor", "Home")'">Eliminar Corredor</button></li>
                        <li> <button class="dropdown-item" type="button" data-bs-toggle="modal" onclick="location.href='@Url.Action("Modificar_Corredor", "Home")'">Modificar Corredor</button></li>
<<<<<<< Updated upstream
                        <li><button class="dropdown-item" type="button" data-bs-toggle="modal" data-bs-target="#importarCorredoresModal">Importar corredores</button></li>
=======
                        <li> <button class="dropdown-item" type="button" data-bs-toggle="modal" onclick="location.href='@Url.Action("Importar_Corredores", "Home")'">Importar corredores</button></li>
                        <li> <button class="dropdown-item" type="button" data-bs-toggle="modal" onclick="location.href='@Url.Action("Importar_tiempos", "Home")'">Importar tiempos</button></li>
>>>>>>> Stashed changes
                        <li> <button class="dropdown-item" type="button" data-bs-toggle="modal" onclick="location.href='@Url.Action("Exportar_corredor", "Home")'">Exportar Corredor</button></li>
                        <li> <button class="dropdown-item" type="button" data-bs-toggle="modal" onclick="location.href='@Url.Action("Reporte_corredor", "Home")'">Reporte de Corredor</button></li>
                    </ul>
                </div>
            </div>
            <div class="col-4"><button class="btn btn-outline-light " style="background-color:#004A98 ;width:max-content;">Exportar resultados</button></div>
        </div>
        <br>
        <br>
        <div class="row">
            <div class="col-2"></div>
            <div class="col-4"><button class="btn btn-outline-light" style="background-color:#004A98; width:max-content;">Mostrar base de datos </button></div>
            <div class="col-4">
                <div class="dropdown">
                    <button type="button" class="btn btn-outline-light dropdown-toggle" style="background-color:#004A98 ;width:max-content;" data-bs-toggle="dropdown" id="gestionCarreras" aria-expanded="false">Gestión de carreras</button>
                    <ul class="dropdown-menu" aria-labelledby="gestionCarreras">
                        <button class="dropdown-item" onclick="window.location.href='@Url.Action("Crear_Carrera", "Home")'">Nueva Carrera</button>
                        <button class="dropdown-item" onclick="window.location.href='@Url.Action("Eliminar_Carrera", "Home")'">Eliminar Carrera</button>
                        <button class="dropdown-item" onclick="window.location.href='@Url.Action("Editar_Carrera", "Home")'">Editar Carrera</button>
                        <li> <button class="dropdown-item" type="button" data-bs-toggle="modal" onclick="location.href='@Url.Action("Reporte_carrera", "Home")'">Generar reporte de carrera</button></li>

                    </ul>
                </div>
            </div>

        </div>
    </div>


    <!-- Modal para eliminar corredor -->
    <!-- Modal para modificar corredor -->
    <!-- Modal para Exportar Corredores -->
    <!-- Modal para Reporte de Corredor -->
    <!-- New Race Modal -->
    <!-- Modal para eliminar carrera -->
    <!-- Modal para modificar carrera -->
    <!--Generar reporte de carrera-->
    <div id="importarCorredoresModal" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="menuImportarCorredores" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div id="cabeceraMenu" class="modal-header">
                    <h5 class="modal-title" id="menuImportarCorredores">Importar Corredores</h5>
                </div>
                <div class="container">
                    <form asp-controller="Home" asp-action="Upload" method="post" enctype="multipart/form-data">
                        <div class="form-group">
                            <label for="fileUpload">Selecciona un archivo Excel (.xlsx)</label>
                            <input type="file" class="form-control-file" id="fileUpload" name="fileUpload" accept=".xlsx" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Subir</button>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
                    <div class="ms-auto">
                        <button type="submit" class="btn btn-primary">Importar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    async function crearCarrera() {
        const nombreCarrera = document.getElementById('nombreCarrera').value;
        const yearCarrera = document.getElementById('yearCarrera').value;

        // Verificación de campos vacíos
        if (!nombreCarrera || !yearCarrera) {
            Swal.fire({
                icon: 'error',
                title: 'Campos incompletos',
                text: 'Por favor, complete todos los campos.'
            });
            return;
        }

        try {
            // Enviar los datos al servidor con fetch
            const response = await fetch('@Url.Action("Alta_Carrera", "Home")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    nom_carrera: nombreCarrera,
                    year_carrera: parseInt(yearCarrera)
                })
            });

            const result = await response.json();
            // Mostrar mensaje de éxito o error según el resultado
            if (result.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Éxito',
                    text: result.message,
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    // Redirigir a Pantalla_ini
                    window.location.href = '@Url.Action("Pantalla_ini", "Home")';
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: result.message
                });
            }
        } catch (error) {
            // Mostrar mensaje de error en caso de fallo de la solicitud
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Ocurrió un error al intentar crear la carrera. Intente nuevamente.'
            });
        }
    }
</script>

<script>
    // Cargar las carreras en el desplegable
    async function cargarCarreras() {
        const response = await fetch('@Url.Action("ObtenerCarreras", "Home")');
        const carreras = await response.json();

        const select = document.getElementById('carreraSeleccionada');
        carreras.forEach(carrera => {
            const option = document.createElement('option');
            option.value = carrera.Id;
            option.textContent = carrera.Descripcion;
            select.appendChild(option);
        });
    }

    // Cargar los parámetros de la carrera seleccionada
    async function cargarParametrosCarrera() {
        const carreraId = document.getElementById('carreraSeleccionada').value;

        if (carreraId) {
            const response = await fetch('@Url.Action("VerificarTiempos", "Home")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ carreraId: carreraId })
            });
            const result = await response.json();

            if (result.success) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'La carrera tiene tiempos registrados y no puede ser eliminada.'
                });
                document.querySelector('.btn-primary').disabled = true;
            } else {
                document.querySelector('.btn-primary').disabled = false;
            }
        }
    }

    // Eliminar la carrera seleccionada
    async function eliminarCarrera() {
        const carreraId = document.getElementById('carreraSeleccionada').value;

        if (!carreraId) {
            Swal.fire({
                icon: 'error',
                title: 'Selecciona una carrera',
                text: 'Por favor, selecciona una carrera para eliminar.'
            });
            return;
        }

        try {
            const response = await fetch('@Url.Action("Baja_Carrera", "Home")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ carreraId: carreraId })
            });

            const result = await response.json();
            if (result.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Carrera eliminada',
                    text: 'La carrera ha sido eliminada correctamente.',
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    window.location.reload();
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Hubo un problema al eliminar la carrera.'
                });
            }
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Ocurrió un error al intentar eliminar la carrera. Intente nuevamente.'
            });
        }
    }

    // Inicializar los datos cuando se cargue la página
    document.addEventListener('DOMContentLoaded', cargarCarreras);
<<<<<<< Updated upstream
=======
</script>

<script>
    //agregado
    document.querySelector("#logoutButton").addEventListener("click", function () {
        fetch('/Home/Logout', { method: 'POST' })
            .then(response => {
                window.location.replace("/Home/Index"); // Redirige sin guardar en el historial
            });
    });
    document.addEventListener("DOMContentLoaded", function () {
        const yearSelect = document.getElementById("yearCarrera");
        const ediSelect = document.getElementById("ediCarrera");
        const catSelect = document.getElementById("categoria");
        const nameInput = document.getElementById("nombreCorredor");

        // 🔹 Restaurar valores guardados en localStorage después de una búsqueda
        yearSelect.value = localStorage.getItem("yearCarrera") || "";
        ediSelect.value = localStorage.getItem("ediCarrera") || "";
        catSelect.value = localStorage.getItem("categoria") || "";
        nameInput.value = localStorage.getItem("nombreCorredor") || "";

        // 🔹 Guardar valores en localStorage antes de enviar el formulario
        document.getElementById("searchForm").addEventListener("submit", function () {
            localStorage.setItem("yearCarrera", yearSelect.value);
            localStorage.setItem("ediCarrera", ediSelect.value);
            localStorage.setItem("categoria", catSelect.value);
            localStorage.setItem("nombreCorredor", nameInput.value);
        });

        // 🔹 Función para cargar ediciones cuando se selecciona un año
        function cargarEdiciones() {
            let year = yearSelect.value;
            ediSelect.innerHTML = '<option value="">Seleccione una edición</option>';
            catSelect.innerHTML = '<option value="">Seleccione una categoría</option>'; // Resetear categorías

            if (year) {
                fetch(`/Home/CargarEdiciones?yearCarrera=${year}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(edi => {
                            let selected = edi == localStorage.getItem("ediCarrera") ? "selected" : "";
                            ediSelect.innerHTML += `<option value="${edi}" ${selected}>${edi}</option>`;
                        });

                        // Si hay ediciones cargadas y había una selección previa, dispara el evento de cambio
                        if (localStorage.getItem("ediCarrera")) {
                            ediSelect.value = localStorage.getItem("ediCarrera");
                            cargarCategorias();
                        }
                    })
                    .catch(error => console.error("Error al cargar ediciones:", error));
            }
        }

        // 🔹 Función para cargar categorías cuando se selecciona una edición
        function cargarCategorias() {
            let year = yearSelect.value;
            let edi = ediSelect.value;
            catSelect.innerHTML = '<option value="">Seleccione una categoría</option>'; // Resetear categorías

            if (year && edi) {
                fetch(`/Home/CargarCategorias?yearCarrera=${year}&ediCarrera=${edi}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(cat => {
                            let selected = cat === localStorage.getItem("categoria") ? "selected" : "";
                            catSelect.innerHTML += `<option value="${cat}" ${selected}>${cat}</option>`;
                        });

                        // Si había una categoría seleccionada, restáurala
                        if (localStorage.getItem("categoria")) {
                            catSelect.value = localStorage.getItem("categoria");
                        }
                    })
                    .catch(error => console.error("Error al cargar categorías:", error));
            }
        }

        // 🔹 Eventos para cargar ediciones y categorías dinámicamente
        yearSelect.addEventListener("change", cargarEdiciones);
        ediSelect.addEventListener("change", cargarCategorias);

        // 🔹 Disparar eventos después de cargar la página para restaurar datos
        if (yearSelect.value) {
            cargarEdiciones();
        }
    });
</script>

<script>
    document.getElementById("btnExportar").addEventListener("click", function () {
        let rows = document.querySelectorAll("#resultTable tbody tr");
        let corredores = [];

        rows.forEach(row => {
            let cols = row.querySelectorAll("td");
            if (cols.length > 0) {
                corredores.push({
                    Posicion: cols[0].innerText.trim(),
                    Numero: cols[1].innerText.trim(),
                    Nombre: cols[2].innerText.trim(),
                    T1: cols[3].innerText.trim(),
                    T2: cols[4].innerText.trim(),
                    T3: cols[5].innerText.trim(),
                    TiempoTotal: cols[6].innerText.trim()
                });
            }
        });

        // Capturar los parámetros de búsqueda
        let filtros = {
            NombreBuscado: document.getElementById("nombreCorredor").value,
            Año: document.getElementById("yearCarrera").value,
            Edicion: document.getElementById("ediCarrera").value,
            Categoria: document.getElementById("categoria").value
        };

        fetch('/Home/ExportarResultados', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filtros, corredores })
        })
            .then(response => response.blob())
            .then(blob => {
                let url = window.URL.createObjectURL(blob);
                let a = document.createElement("a");
                a.href = url;
                a.download = "ResultadosBusqueda.pdf";
                document.body.appendChild(a);
                a.click();
                a.remove();
            })
            .catch(error => console.error("Error al generar PDF:", error));
    });
>>>>>>> Stashed changes
</script>